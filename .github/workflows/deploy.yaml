name: CI/CD - Deploy Nginx to k3s

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Deploy to k3s
    runs-on: self-hosted

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'latest'

      - name: Configure kubeconfig
        run: |
          echo "${{ secrets.KUBECONFIG_DATA }}" | base64 -d > kubeconfig
          chmod 600 kubeconfig
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig

      - name: Verify Cluster Access
        run: kubectl get nodes
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig

      - name: Deploy Nginx Application
        run: |
          kubectl apply -f ansible/k8s/deployment.yaml
          kubectl rollout status deployment/nginx-hello-world --timeout=120s
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig

      - name: Verify Deployment
        run: |
          kubectl get pods
          kubectl get svc
        env:
          KUBECONFIG: ${{ github.workspace }}/kubeconfig
